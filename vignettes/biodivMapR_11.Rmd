---
title: "PROGYSAT#1: download S2 data"
author: "Jean-Baptiste FÃ©ret"
date: "`r Sys.Date()`"
output:
  html_vignette:
    number_sections: true
vignette: >
  %\VignetteIndexEntry{PROGYSAT#1}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  eval=FALSE
)
options(rmarkdown.html_vignette.check_title = FALSE)
```

This tutorial illustrates how to download and preprocess Sentinel-2 data for the application of 
`biodivMapR` in order to map spectral diversity over a site in Suriname.

This first step is based on the R package [`preprocS2`](https://jbferet.gitlab.io/preprocS2/index.html), which needs to be installed, along with additional packages such as [`sen2r`](https://sen2r.ranghetti.info/)

This includes: 
- S2 data download based on a spatial footprint
- atmospheric correction of S2 images to produce L2A images with Sen2Cor
- cropping, stacking and writing the reflectance raster corresponding to th espatial footprint, as well as the corresponding cloud mask


### Define structure for data, R scripts and results

In order to organize this tutorial, I will assume that the file structure is defined as follows: 
- `01_DATA`: a directory including original vector and raster files (Sentinel-2 data products level L1C and L2A before further process)
- `02_PROGRAMS`: where all r scripts should be located. Here, all R scripts provided in this tutorial will assume that you set your working directory `02_PROGRAMS`
- `03_RESULTS`: all files resulting from the application of the R scripts on the data located in `01_DATA`, or in this same `03_RESULTS` directory


### Download a vector file corresponding to the spatial footprint of the study area

You can use QGIS or Google Earth to define the spatial footprint. Here, we drew a rectangular polygon over a forested area in the Eastern part of the Brokopondo reservoir in Suriname.

We first download the kml file corresponding to our study area and save it in the `01_DATA` directory.

```{r download_vector_data}
# define data directory
Path_Data <- '../01_DATA'
dir.create(Path_Data,showWarnings = F, recursive = T)
# name zip file including plots located on the tile
destkml <- file.path(Path_Data,'Suriname_Progysat_Workshop.kml',fsep = '\\')
# url for the zip file
url <- 'https://gitlab.com/jbferet/myshareddata/-/raw/master/PROGYSAT/01_DATA/Suriname_Progysat_Workshop.kml'
download.file(url = url, destfile = destzip)
```

### Download Sentinel-2 data and perform atmospheric corrections with sen2Cor

Then, we use [Sentinel-hub](https://apps.sentinel-hub.com/eo-browser/?zoom=11&lat=4.7602&lng=-54.92889&themeId=DEFAULT-THEME&visualizationUrl=https%3A%2F%2Fservices.sentinel-hub.com%2Fogc%2Fwms%2Fbd86bcc0-f318-402b-a145-015f85b9427e&datasetId=S2L2A&fromTime=2020-10-16T00%3A00%3A00.000Z&toTime=2020-10-16T23%3A59%3A59.999Z&layerId=1_TRUE_COLOR&demSource3D=%22MAPZEN%22) in order to identify an acquisition corresponding to our requirement. 

Once the S2 tile and the date of acquisition are identified, we can proceed to the image download. Here, the selected acquisition is from October 16th, 2020. 

We then used the R package [`preprocS2`](https://jbferet.gitlab.io/preprocS2/index.html) in order to download the corresponding Sentinel-2 SAFE archive. Here, level-2A images (atmospherically corrected with Sen2Cor) are not available, and only L1C images can be downloaded from [SciHub](https://scihub.copernicus.eu).

the function `get_S2_L2A_Image` allows to automatically download S2 images and perform atmospheric corrections with Sen2Cor if needed. 


```{r download_S2_image}
################################################################################
## S2 download & atmospheric correction using preprocS2
################################################################################
library(preprocS2)
# define date of S2 acquisition
dateAcq <- '2020-10-16'
# define path for study area
path_vector <- destkml
# define output directory where SAFE L2C and L2A files are stored. L1C is 
# automatically deleted after production of L2A to save space
DirWrite <- '../01_DATA/S2_Images'
dir.create(DirWrite,showWarnings = F, recursive = T)

Path_S2 <- get_S2_L2A_Image(l2a_path = DirWrite, 
                            spatial_extent = path_vector, 
                            dateAcq = dateAcq,
                            DeleteL1C = TRUE, 
                            Sen2Cor = TRUE)

```


### Save cropped & stacked BOA reflectance and corresponding cloud mask

Sentinel-2 products are made available in the [SAFE](https://sentinels.copernicus.eu/web/sentinel/user-guides/sentinel-2-msi/data-formats) format, including image data in JPEG2000 format, quality indicators (e.g. defective pixels mask), auxiliary data and metadata. 

The `preprocS2` function `extract_from_S2_L2A` aims at extracting all information required for further processing, including reflectance data, cloud mask and metadata. It also crops S2 data following a spatial extent defined by `path_vector`, and it harmonizes the spatial resolution to either 20 meters, or 10 meters using user defined interpolation (bilinear as default).

If the vector file and the raster data do not share the same projection, the vector file is also reprojected to avoid possible errors in future processings. 


```{r extract_raster_data}
################################################################################
## write a stacked reflectance raster corresponding to the study area
################################################################################
# Result directory where data is stored 
result_path <- '../03_RESULTS'
dir.create(path = result_path,showWarnings = FALSE,recursive = TRUE)

##____________________________________________________________________________##
##      Extract, resample all bands to 10m spatial resolution & stack data    ##
##----------------------------------------------------------------------------##
# define spatial resolution
resolution <- 10
# define source of data
S2source <- 'SAFE'
S2obj <- preprocS2::extract_from_S2_L2A(Path_dir_S2 = Path_S2,
                                        path_vector = path_vector,
                                        S2source = S2source,
                                        resolution = resolution)

# update vector file if needed (reprojection and write as shapefile in the same 
# location as the original file)
path_vector <- S2obj$path_vector
```



A stars object is obtained as output from `extract_from_S2_L2A`. This is a proxy stars object, in order to handle large rasters. This stars object includes the reflectance data and corresponding cloud mask.

These will be written on your local space with the functions `save_cloud_s2` and `save_reflectance_s2`

```{r write_raster_data}
# create specific result directory corresponding to granule name
results_site_path <- file.path(result_path,basename(S2obj$S2_Bands$GRANULE))
dir.create(path = results_site_path,showWarnings = FALSE,recursive = TRUE)

## Write CLOUD MASK
cloudmasks <- preprocS2::save_cloud_s2(S2_stars = S2obj$S2_Stack,
                                       Cloud_path = results_site_path,
                                       S2source = S2source, SaveRaw = T)

## Write REFLECTANCE
# Save Reflectance file as ENVI image with BIL interleaves
# metadata files are also important to account for offset applied on S2 L2A products 
Refl_path <- file.path(results_site_path,paste(basename(S2obj$S2_Bands$GRANULE),'_Refl',sep = ''))
tile_S2 <- get_tile(S2obj$S2_Bands$GRANULE)
dateAcq_S2 <- get_date(S2obj$S2_Bands$GRANULE)
preprocS2::save_reflectance_s2(S2_stars = S2obj$S2_Stack, 
                               Refl_path = Refl_path,
                               S2Sat = NULL, 
                               tile_S2 = tile_S2, 
                               dateAcq_S2 = dateAcq_S2,
                               Format = 'ENVI', 
                               datatype = 'Int16', 
                               MTD = S2obj$S2_Bands$metadata, 
                               MTD_MSI = S2obj$S2_Bands$metadata_MSI)


```

Once S2 acquisition and corresponding cloud mask are downloaded and written on your disk, you can then run `biodivMapR`
